# åœ¨ IBM Cloud ä¸Šæ„å»ºäº‘å°±ç»ªçš„ Express.js åº”ç”¨ç¨‹åº

> åŸæ–‡ï¼š[`developer.ibm.com/zh/tutorials/deploy-cloud-native-expressjs-app-to-a-hosted-kubernetes-cluster/`](https://developer.ibm.com/zh/tutorials/deploy-cloud-native-expressjs-app-to-a-hosted-kubernetes-cluster/)

Web åº”ç”¨ç¨‹åºåŠŸèƒ½å¼ºå¤§ï¼Œåœ¨ä¼ä¸šå’Œä¸ªäººä½¿ç”¨ä¸Šå…·æœ‰å¾ˆå¤§çš„æ½œåŠ›ã€‚ä½†åœ¨åˆ›å»ºã€ä½¿ç”¨å’Œéƒ¨ç½² Web åº”ç”¨ç¨‹åºæ—¶ï¼Œå¿…é¡»ç¡®ä¿å…¶å¯é æ€§ã€å¯æ‰©å±•æ€§ã€å¯ç”¨æ€§ç­‰ã€‚é€šè¿‡å°† Web åº”ç”¨ç¨‹åºå®¹å™¨åŒ–å¹¶éƒ¨ç½²åˆ°äº‘ç«¯ï¼Œå³å¯å¯¹è¿™äº›é‡è¦ä»»åŠ¡åŠ ä»¥å¦¥å–„å¤„ç†ã€‚

æœ¬æ•™ç¨‹å°†é›†ä¸­ä»‹ç»å¦‚ä½•åœ¨ IBM Cloud ä¸Šæ„å»ºäº‘å°±ç»ªçš„ Express.js åº”ç”¨ç¨‹åºã€‚æœ¬æ•™ç¨‹æ˜¯åœ¨ [Building a Cloud Ready Express.js Application](https://github.com/CloudNativeJS/tutorial/blob/master/README.md#building-a-cloud-ready-expressjs-application) å·¥ä½œåŠåŸºç¡€ä¸Šçš„å»¶ä¼¸ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•ä»åŸå§‹æ•™ç¨‹ä¸­æå– Node.js åº”ç”¨ç¨‹åºå¹¶å°†å…¶éƒ¨ç½²åˆ° IBM Cloud ä¸Šçš„ Kubernetes é›†ç¾¤ä¸­ã€‚

## å‰ææ¡ä»¶

**å…è´¹è¯•ç”¨ IBM Cloud**

åˆ©ç”¨ [IBM Cloud Lite](https://cocl.us/IBM_CLOUD_GCG) å¿«é€Ÿè½»æ¾åœ°æ„å»ºæ‚¨çš„ä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚æ‚¨çš„å…è´¹å¸æˆ·ä»ä¸è¿‡æœŸï¼Œè€Œä¸”æ‚¨ä¼šè·å¾— 256 MB çš„ Cloud Foundry è¿è¡Œæ—¶å†…å­˜å’ŒåŒ…å« Kubernetes é›†ç¾¤çš„ 2 GB å­˜å‚¨ç©ºé—´ã€‚[äº†è§£æ‰€æœ‰ç»†èŠ‚](https://www.ibm.com/cloud/blog/announcements/introducing-ibm-cloud-lite-account-2)å¹¶ç¡®å®šå¦‚ä½•å¼€å§‹ã€‚

è¦å®Œæˆæœ¬æ•™ç¨‹ä¸­çš„æ­¥éª¤ï¼Œæ‚¨éœ€è¦ï¼š

*   å…·å¤‡æœ‰å…³å®¹å™¨æŠ€æœ¯çš„åŸºæœ¬çŸ¥è¯†ï¼ŒåŒ…æ‹¬ Kubernetesã€Docker å’Œ Helm
*   åˆ›å»ºä¸€ä¸ª [IBM Cloud å¸æˆ·](https://cocl.us/IBM_CLOUD_GCG)
*   æ ¹æ®[åŸå§‹æ•™ç¨‹](https://github.com/CloudNativeJS/tutorial/blob/master/README.md#building-a-cloud-ready-expressjs-application)åˆ›å»ºåº”ç”¨ç¨‹åºï¼Œä½†å¯é¦–å…ˆä»ä¸‹è¿°ç¬¬ 1 æ­¥å¼€å§‹

## 1\. åˆ›å»º Kubernetes é›†ç¾¤

1.  ä» [IBM Cloud ç›®å½•](https://cloud.ibm.com/kubernetes/catalog/cluster/create?cm_sp=ibmdev-_-developer-tutorials-_-cloudreg)åˆ›å»º Kubernetes é›†ç¾¤

    > æ³¨æ„ï¼šæœ¬æ•™ç¨‹å¯ä½¿ç”¨ **Free** ç±»å‹é›†ç¾¤æ¥å®Œæˆã€‚ä¸ Kubernetes Ingress ç›¸å…³çš„ä¸¤ä¸ªå¯é€‰éƒ¨åˆ†å’Œå®šåˆ¶åŸŸéœ€è¦ç±»å‹ä¸º **Standard** çš„ä»˜è´¹é›†ç¾¤ã€‚

2.  é€‰æ‹© **Cluster type**ï¼Œç„¶åé€‰æ‹© **Cluster name**ï¼Œæ¥ç€å•å‡» **Create Cluster** æ¥é…ç½® Kubernetes é›†ç¾¤ã€‚

    ![é…ç½® Kubernetes é›†ç¾¤](img/189cb8357e9f975dfbe548caf9ede3e7.png)

3.  é…ç½®é›†ç¾¤éœ€è€—æ—¶çº¦ 20 åˆ†é’Ÿã€‚é…ç½®é›†ç¾¤æ—¶ï¼Œæ‚¨å¯ç»§ç»­æ‰§è¡Œæœ¬æ•™ç¨‹çš„ç¬¬ 2 æ­¥ï¼Œç¨åå†è¿”å›æ­¤æ­¥éª¤ã€‚å½“çŠ¶æ€æ˜¾ç¤ºä¸º ***Normal*** æ—¶ï¼Œå³è¡¨ç¤ºé›†ç¾¤å·²å°±ç»ªã€‚æ‰§è¡Œä»¥ä¸‹æ“ä½œä»¥æ£€æŸ¥é›†ç¾¤çŠ¶æ€ï¼š

    ![é…ç½®é›†ç¾¤](img/b2e8f5aba883108e212b7c7f38554afa.png)

    a. é€‰æ‹©å·¦ä¸Šè§’çš„å¯¼èˆªèœå•å›¾æ ‡ä»¥æ˜¾ç¤ºå¯¼èˆªèœå•ã€‚ç„¶åè½¬è‡³ Kubernetesã€‚

    ```
     ![å¯¼èˆªèœå•](https://developer.ibm.com/developer/default/tutorials/deploy-cloud-native-expressjs-app-to-a-hosted-kubernetes-cluster/images/clusters_list.png) 
    ```

    b. ä»ä¾§è¾¹èœå•é€‰æ‹© **Clusters**ï¼Œä»¥æ˜¾ç¤ºå·²é…ç½®çš„é›†ç¾¤åˆ—è¡¨ã€‚æ‰¾åˆ°å·²ä¸ºæ­¤æ•™ç¨‹é…ç½®çš„é›†ç¾¤ã€‚å¦‚æœå…¶çŠ¶æ€ä¸º ***Normal***ï¼ˆå¦‚ä¸Šå›¾æ‰€ç¤ºï¼‰ï¼Œå³è¡¨ç¤ºè¯¥é›†ç¾¤å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä¾›ä½¿ç”¨ã€‚çŠ¶æ€å˜ä¸º ***Normal*** åï¼Œå•å‡»é›†ç¾¤åç§°ä»¥å¯åŠ¨é›†ç¾¤ä»ªè¡¨æ¿ã€‚

    c. éµå¾ªæ–°åˆ›å»ºé›†ç¾¤çš„ **Access** ä¸‹çš„è¯´æ˜æ¥è®¾ç½®é›†ç¾¤çš„è®¿é—®æƒã€‚

    ![è®¾ç½®é›†ç¾¤çš„è®¿é—®æƒ](img/a0390da1e5545bcdaf048b3cdfc784bd.png)

## 2\. æ„å»ºäº‘å°±ç»ªçš„ Express.js åº”ç”¨ç¨‹åº

éµå¾ª[åŸå§‹æ•™ç¨‹](https://github.com/CloudNativeJS/tutorial/blob/master/README.md#building-a-cloud-ready-expressjs-application)ä¸­ä»**è®¾ç½®**åˆ°**ç¬¬ 5 æ­¥**ä¹‹é—´çš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚åœ¨åŸå§‹æ•™ç¨‹ä¸­ï¼Œæ‚¨éœ€è¦å®Œæˆä»¥ä¸‹æ“ä½œï¼š

*   åˆ›å»º Express.js åº”ç”¨ç¨‹åº
*   å‘åº”ç”¨ç¨‹åºæ·»åŠ è¿è¡ŒçŠ¶å†µæ£€æŸ¥å’ŒæŒ‡æ ‡
*   åˆ©ç”¨ Docker æ„å»ºåº”ç”¨ç¨‹åº
*   å°†åº”ç”¨ç¨‹åºä¸ Helm æ‰“åŒ…åœ¨ä¸€èµ·

å®Œæˆæ­¤æ­¥éª¤åï¼Œç¬¬ 1 æ­¥ä¸­çš„ Kubernetes é›†ç¾¤åº”å·²é…ç½®å®Œæˆï¼Œæ­¤æ—¶å¯ç»§ç»­æ‰§è¡Œç¬¬ 3 æ­¥ã€‚

## 3\. å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° IBM Cloud ä¸Šçš„ Kubernetes é›†ç¾¤

ç°åœ¨æ‚¨å·²æ„å»ºäº†åº”ç”¨ç¨‹åºçš„ Helm Chartï¼Œåº”ç”¨ç¨‹åºéƒ¨ç½²æµç¨‹å·²å¤§å¹…ç®€åŒ–ã€‚

ä½¿ç”¨ä»¥ä¸‹æ­¥éª¤å°† Express.js åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetes ä¸­ï¼š

1.  é€šè¿‡åˆ—å‡ºæ³¨å†Œè¡¨ä¸­çš„æ‰€æœ‰åç§°ç©ºé—´æ¥æŸ¥æ‰¾æ‚¨çš„åç§°ç©ºé—´ï¼š

    ```
     ibmcloud cr namespaces 
    ```

    *   å¦‚æœæ‚¨æ²¡æœ‰åç§°ç©ºé—´æˆ–è€…è¦ä½¿ç”¨æ–°çš„åç§°ç©ºé—´ï¼Œé‚£ä¹ˆå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªï¼š

        ```
        ibmcloud cr namespace-add <NAMESPACE> 
        ```

2.  å°† **MYNAMESPACE** å’Œ **MYPROJECT** ç¯å¢ƒå˜é‡åˆ†åˆ«è®¾ç½®ä¸ºåç§°ç©ºé—´å’Œé¡¹ç›®åç§°

    ```
     export MYNAMESPACE=<NAMESPACE>
     export MYPROJECT=nodeserver 
    ```

3.  è¿è¡Œ `ibmcloud cr region` æ¥è¯†åˆ«å®¹å™¨æ³¨å†Œè¡¨ã€‚å°† **MYREGISTRY** ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºæ‚¨çš„æ³¨å†Œè¡¨ã€‚

    ```
     export MYREGISTRY=<REGISTRY> 
    ```

4.  è¿è¡Œ `docker tag nodeserver-run:1.0.0 ${MYREGISTRY}/${MYNAMESPACE}/${MYPROJECT}:v1.0.0`ï¼Œä¸ºç”¨äºåˆ›å»ºå®¹å™¨ä»¥æœ¬åœ°è¿è¡Œåº”ç”¨çš„ Docker é•œåƒæ·»åŠ æ ‡è®°

5.  å°†è¯¥ Docker é•œåƒæ¨é€åˆ° IBM Cloud ä¸Šçš„å®¹å™¨æ³¨å†Œè¡¨ï¼š

    ```
     ibmcloud cr login
     docker push ${MYREGISTRY}/${MYNAMESPACE}/${MYPROJECT}:v1.0.0 
    ```

6.  åˆå§‹åŒ– Helm

    *   åœ¨ `chart/nodeserver` ä¸­åˆ›å»ºåä¸º `rbac.yaml` çš„æ–‡ä»¶ã€‚æ­¤æ–‡ä»¶å°†å……å½“é…ç½®æ–‡ä»¶ï¼Œç”¨äºåˆ›å»ºå¯¹é›†ç¾¤å…·æœ‰ cluster-admin è§’è‰²çš„æœåŠ¡å¸æˆ·ã€‚å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°æ­¤æ–‡ä»¶ä¸­ï¼š

        ```
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: tiller
          namespace: kube-system
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: tiller
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
          - kind: ServiceAccount
            name: tiller
            namespace: kube-system 
        ```

    *   ä» `chart/nodeserver` ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è®¾ç½®é…ç½®ï¼š

        ```
        kubectl create -f rbac.yaml
        helm init --service-account tiller 
        ```

    *   è¦éªŒè¯ Helm æ˜¯å¦å·²æ­£ç¡®é…ç½®å¹¶ä¸”æ­£åœ¨è¿è¡Œï¼Œå¯è¿è¡Œ `helm version`ï¼Œå¹¶éªŒè¯ ***Client*** ä¸ ***Server*** è¿è¡Œçš„ç‰ˆæœ¬æ˜¯å¦ç›¸åŒã€‚

7.  åœ¨ IBM Cloud ä¸Šå®‰è£… Helm Chart

    *   å°† `chart/nodeserver/values.yaml` æ–‡ä»¶ä¿®æ”¹ä¸ºä½¿ç”¨ IBM Cloud å®¹å™¨æ³¨å†Œè¡¨ä¸Šçš„é•œåƒã€‚è¿è¡Œ `echo ${MYREGISTRY}/${MYNAMESPACE}/${MYPROJECT}`ï¼Œå¹¶å°† `repository` å­—æ®µæ›´æ”¹ä¸ºæ­¤å‘½ä»¤çš„ç»“æœã€‚æ­¤å¤–ï¼Œå°† `tag` å­—æ®µæ›´æ”¹ä¸º `v1.0.0`ã€‚

        > æ³¨æ„ï¼šå¦‚æœå®¹å™¨æ³¨å†Œè¡¨ä»¥ `bluemix.net` ç»“æŸï¼Œé‚£ä¹ˆè½¬è‡³[æ­¤å¤„](https://cloud.ibm.com/docs/services/Registry?topic=registry-registry_overview#registry_regions_local)ï¼ŒæŸ¥æ‰¾ä»¥ `icr.io` ç»“å°¾çš„å·²æ›´æ–°æ³¨å†Œè¡¨åŒºåŸŸçš„åŸŸåï¼Œå¹¶é’ˆå¯¹ `chart/nodeserver/values.yaml` ä¸­çš„ `repository` å¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚

    *   ä» `chart/nodeserver` ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä»¥åœ¨äº‘ä¸Šå®‰è£… Helm Chartï¼š

        ```
        helm install .--name ${MYPROJECT} 
        ```

        å¦‚æœåº”ç”¨ç¨‹åºéƒ¨ç½²æˆåŠŸï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€æ¡ç¡®è®¤æ¶ˆæ¯ã€‚è¦è®¿é—®äº‘ä¸Šç›®å‰æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œå¯è¿è¡Œ `kubectl get services` å¹¶æ‰¾åˆ° `nodeserver-service` çš„ `PORT`ã€‚æ¥ä¸‹æ¥ï¼Œè½¬è‡³ IBM Cloud ä¸Šçš„é›†ç¾¤ä»ªè¡¨æ¿ï¼Œæ‰¾åˆ°é›†ç¾¤å·¥ä½œèŠ‚ç‚¹çš„ `Public IP`ã€‚

        ![Public IP](img/fa461aa0c1b71a1f41c3ea07e6d7d3a0.png)

        åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ–°é€‰é¡¹å¡/çª—å£ï¼Œå¹¶è½¬è‡³<public ip="ip">ï¼š</public>

        ç°åœ¨ï¼Œæ‚¨åº”å¯åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°äº‘ä¸Šæ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚

## 4\. ç›‘è§†åº”ç”¨ç¨‹åº

IBM Cloud æä¾›äº† Kubernetes ä»ªè¡¨æ¿ï¼Œç”¨äºåœ¨äº‘ä¸Šç›‘è§† Kubernetesã€‚å¯é€šè¿‡ IBM Cloud ä»ªè¡¨æ¿ä¸Šçš„é›†ç¾¤è®¿é—®æ­¤ä»ªè¡¨æ¿ã€‚

![Kubernetes ä»ªè¡¨æ¿](img/d6b99eb833772995c4eaa16d97c96d78.png)

## æ­å–œï¼ğŸ‰

ç°åœ¨ï¼Œæ‚¨å·²åœ¨ IBM Cloud ä¸Šä½¿ç”¨ Dockerã€Helm å’Œ Kubernetes éƒ¨ç½²äº† Express.js åº”ç”¨ç¨‹åºï¼

æœ¬æ–‡ç¿»è¯‘è‡ªï¼š[Build a cloud-ready Express.js application on IBM Cloud](https://developer.ibm.com/tutorials/deploy-cloud-native-expressjs-app-to-a-hosted-kubernetes-cluster/)ï¼ˆ2019-05-17ï¼‰